{% extends 'vin_processor/base.html' %}

{% block title %}הכנס מספר VIN | Treatment Wizard{% endblock %}

{% block content %}
<section class="hero-section">
    <div class="hero-content">
        <!-- הסרנו את hero-title וה-hero-subtitle -->

        <div class="vin-card">
            <input
                type="text"
                id="vinInput"
                class="vin-input"
                placeholder="הכנס מספר VIN"
                maxlength="17"
            >
            <button id="startBtn" class="btn-primary">יצירת קיט טיפולים</button>

            <div id="loadingContainer" class="loading-container">
                <div class="spinner"></div>
                <div class="loading-text" id="loadingText">מאתחל מערכת...</div>
                <div class="loading-percentage" id="loadingPercentage">0%</div>
            </div>

            <div id="errorMsg" class="error-message" style="display: none;"></div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    const vinInput = document.getElementById('vinInput');
    const startBtn = document.getElementById('startBtn');
    const loadingContainer = document.getElementById('loadingContainer');
    const loadingText = document.getElementById('loadingText');
    const loadingPercentage = document.getElementById('loadingPercentage');
    const errorMsg = document.getElementById('errorMsg');

    const loadingSteps = [
        'מאתחל מערכת...',
        'זיהוי דגם מ-VIN...',
        'חילוץ טיפולים מ-PDF...',
        'סיווג שורות טיפול...',
        'חילוץ חלקים מ-PET...',
        'התאמת חלקים לשירותים...',
        'יצירת סלי שירות...',
        'מסיים עיבוד...'
    ];

    startBtn.addEventListener('click', async () => {
        const vin = vinInput.value.trim().toUpperCase();

        if (vin.length !== 17) {
            showError('מספר VIN חייב להיות בדיוק 17 תווים');
            return;
        }

        hideError();
        startBtn.disabled = true;
        vinInput.disabled = true;
        loadingContainer.classList.add('active');

        try {
            const formData = new FormData();
            formData.append('vin', vin);

            const response = await fetch('/start/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.redirect) {
                window.location.href = data.redirect;
                return;
            }

            if (data.task_id) {
                pollProgress(data.task_id);
            }
        } catch (error) {
            showError('שגיאה בתקשורת עם השרת');
            resetForm();
        }
    });

    function pollProgress(taskId) {
        const interval = setInterval(async () => {
            try {
                const response = await fetch(`/progress/${taskId}/`);
                const data = await response.json();

                // Slow down progress for effect (multiply by 0.8)
                const adjustedProgress = Math.floor(data.progress * 0.8);

                updateProgress(adjustedProgress, data.current_step);

                if (data.status === 'COMPLETED') {
                    clearInterval(interval);
                    updateProgress(100, 'הושלם בהצלחה!');
                    setTimeout(() => {
                        window.location.href = `/results/${taskId}/`;
                    }, 1000);
                } else if (data.status === 'FAILED') {
                    clearInterval(interval);
                    showError('שגיאה: ' + data.error_message);
                    resetForm();
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }, 800);
    }

    function updateProgress(percentage, step) {
        loadingPercentage.textContent = percentage + '%';

        const stepIndex = Math.floor((percentage / 100) * (loadingSteps.length - 1));
        loadingText.textContent = step || loadingSteps[stepIndex];
    }

    function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
    }

    function hideError() {
        errorMsg.style.display = 'none';
    }

    function resetForm() {
        startBtn.disabled = false;
        vinInput.disabled = false;
        loadingContainer.classList.remove('active');
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
