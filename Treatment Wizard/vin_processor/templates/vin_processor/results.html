{% extends 'vin_processor/base.html' %}
{% load custom_filters %}
{% load humanize %}

{% block title %}תוצאות - {{ vin }}{% endblock %}

{% block content %}
<div class="results-container">
    <div class="results-header">
        <div class="results-vin" title="VIN">{{ vin }}</div>

        <div class="results-info">
            <div class="info-item">
                <div class="info-label">דגם הרכב</div>
                <div class="info-value">{{ model }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">סה"כ טיפולים</div>
                <div class="info-value">{{ services|length }}</div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
        {% for km, service_data in services.items %}
        <button class="tab-button {% if forloop.first %}active{% endif %}"
                onclick="showTab('{{ km }}', this)">
            {{ service_data.mileage_km|intcomma }} ק"מ
        </button>
        {% endfor %}
    </div>

    <!-- Tab Contents -->
    {% for km, service_data in services.items %}
    <div id="tab-{{ km }}" class="tab-content {% if forloop.first %}active{% endif %}">
        <div class="service-meta">
            <div class="service-meta-item">
                <span class="service-meta-label">טיפול מספר:</span>
                <span class="service-meta-value">{{ service_data.service_number }}</span>
            </div>
            <div class="service-meta-item">
                <span class="service-meta-label">קילומטראז':</span>
                <span class="service-meta-value">{{ service_data.mileage_km|intcomma }} ק"מ</span>
            </div>
            <div class="service-meta-item">
                <span class="service-meta-label">סה"כ חלקים:</span>
                <span class="service-meta-value">{{ service_data.matched_parts|length }}</span>
            </div>
        </div>

        <table class="parts-table">
            <thead>
                <tr>
                    <th>שורת שירות</th>
                    <th>מספר חלק</th>
                    <th>תיאור</th>
                    <th>הערה</th>
                    <th>כמות</th>
                </tr>
            </thead>
            <tbody>
                {% for part in service_data.matched_parts %}
                <tr>
                    <td>{{ part|lookup:"SERVICE LINE" }}</td>
                    <td class="part-number">{{ part|lookup:"PART NUMBER" }}</td>
                    <td>{{ part|lookup:"DESCRIPTION" }}</td>
                    <td>{{ part|lookup:"REMARK"|default:"—" }}</td>
                    <td class="part-quantity">{{ part|lookup:"QUANTITY" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}

    <a href="{% url 'home' %}" class="btn-back">← חזרה לדף הבית</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showTab(tabId, button) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Remove active from all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        document.getElementById('tab-' + tabId).classList.add('active');
        button.classList.add('active');
    }
</script>
{% endblock %}
